# Тесты для бутлоадера датчиков CAN

## LSS
__*Тесты проверяющие повдения службы LSS в устройстве*__

### lss.py 
pytest тестовый сценарий. Для проведения тестов необходимо установить
скорость can вручную
```
# ip link set <canX> up type can bitrate <speed> loopback off
```
Проводит следующие тесты
* Глобальное переключение режимов LSS
* Селективное переключение режимов LSS
* Переключение скорости CAN, без применения настроек
* Запрос идентификационных данных LSS
* Установка Canopen NODE ID
    
### canopen_lss_fastscan.py 
python-скрипт, вызывающий процедуру LSS fast scan.
Возвращает идентификационные дынные НЕНАСТРОЕННОГО устройства с МЕНЬШИМ LSS идентификатором.

### lss_bitrates.py
pytest тестовый сценарий. Проверяет установку скорости обмена с загрузчиком.

## NMT
__*Тесты, проверяющие работу NMT*__

### nmt.py
pytest тестовый сценарий. Проверяет реакцию загрузчика на команды NMT
RESET COMMUNICATION и RESET, посланые глобально или адресно.

## SDO
__*Тесты, проверяющие работу SDO*__

### sdo_errorlog.py
pytest тестовый сценарий. Проверяет поведение журнала ошибок 0x1003
- Журнал состоит из одной записи (для бутлоадера норм)
- Запись 0 в 0x1003sub0 очищает журнал ошибок
- 0x1003sub1 состояние записи во флешку - коды из enum class FlashStatus

### sdo_read_all.py
pytest тестовый сценарий. Пытается читать все объекты Object dictionary
Примечание: `canopen.sdo.exceptions.SdoAbortedError` с кодом **0x06010001**
Ощибкой не считается.

### sdo_firmware.py
pytest тестовый сценарий. Проводит тестирование записи прошивки, валидации
и запуска
Для данного теста требуются любые собранные образы приложения в каталоге с тестом
* app.bin - сырой двоичный образ приложения
* app.deploy - зашифрованый образ приложения

Тест выполняет следующие проверки
- Попытка чтения образа приложения из 1f50sub1 должна вызывать ошибку
- Выбор типа шифрования образа
- Запись "пустого" образа
- Проверка CRC32 пустрого образа
- Сброс лога ошибок запуска
- Запись сырого и зашифрованноог образов приложения
- Проверка верности записи путем бзапроса CRC32 записанного образа приложения
- Запись зашифрованного образа как сырого, вызывает ошибку проверки целостности приложения


# Запуск тестов
* Собрать образ прошивки и пложить в этот каталог с именем `app.bin`
* Перед запуском тестов нужно убедиться, что скорость can-шины установлена
в дефолтное значение для дагрузчика (`common.py:default_bitrate`)
* Загрузчик сброшен и не имеет адреса LSS
* При помощи canopen_lss_fastscan.py убедиться в присутствии устройства на шине
(Не забыть указать `-I canX`)
* Запустить тест lss.py
* Запустить тест lss_bitrates.py
* Запустить тест nmt.py
* Запустить тест sdo_errorlog.py
* Запустить тест sdo_read_all.py
* Запустить тест sdo_firmware.py

Можно сразу все пачкой, кроме mnt.py
`$ pytest lss.py lss_bitrates.py sdo_errorlog.py sdo_read_all.py sdo_firmware.py`